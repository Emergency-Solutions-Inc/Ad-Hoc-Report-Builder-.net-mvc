@using System.Configuration
@model List<DotNetReportDashboardModel>
@{
ViewBag.Title = "Dashboard";
Layout = "~/Views/shared/_Layout.Report.cshtml";
}

<h2>Dashboard</h2>

@section head {
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.min.css" />
}

@section scripts{
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.min.js'></script>
<script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.jQueryUI.min.js'></script>
<script type="text/javascript">
    $(document).ready(function () {
        var reports = [];

        @foreach (var r in Model)
        {
        @:reports.push({ reportSql: "@r.ReportSql", reportId: @r.ReportId, reportFilter: htmlDecode('@HttpUtility.UrlDecode(r.ReportFilter)'), connectKey: "@r.ConnectKey" });
        }

        ajaxcall({ url: '@Url.Action("GetUsersAndRoles")' }).done(function (data) {
            var vm = new dashboardViewModel({
                runReportUrl: "@Url.Action("Report")",
                execReportUrl: "@Url.Action("RunReport")",
                reportWizard: $("#filter-panel"),
                lookupListUrl: "@Url.Action("GetLookupList")",
                apiUrl: "@Url.Action("CallReportApi")",
                runReportApiUrl: "@Url.Action("RunReportApi")",
                reportMode: "execute",
                reports: reports,
                users: data.users,
                userRoles: data.userRoles
            });

            ko.applyBindings(vm);

            $(function () {
                var options = {
                    cellHeight: 200
                };
                $('.grid-stack').gridstack(options);
            });

            $(window).resize(function () {
                vm.drawChart();
            });
        });        
    });
</script>
}

<!-- ko if: dashboards().length > 0 -->
<div class="form-inline">
    <div class="form-group">
        <div class="control-group">
            <label class="control-label">Available Dashboards</label>
            <select class="form-control" style="max-width: 300px;" data-bind="options: dashboards, optionsText: 'Name', optionsValue: 'Id', value: currentDashboard"></select>            
            <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#add-dashboard-modal">Add New Connection</button>
        </div>
    </div>
</div>
<!-- /ko -->
<!-- ko if: dashboards().length == 0 -->
<div class="centered">
    Start here by <button class="btn btn-lg btn-primary">Create a New Dashboard</button>
</div>
<!-- /ko -->

<div class="grid-stack">
    <!-- ko foreach: reports -->
    <div class="grid-stack-item" data-bind="attr: {'data-gs-x': x, 'data-gs-y': y, 'data-gs-width': width, 'data-gs-height': height, 'data-gs-auto-position': true}">
        <div class="grid-stack-item-content">
            <div class="panel panel-primary">
                <div class="panel-heading panel-nocollapse">
                    <span data-bind="text: ReportName"></span>
                    <div class="pull-right">
                        @using (Html.BeginForm("DownloadExcel", "Report", FormMethod.Post))
                        {
                        <input type="hidden" id="reportSql" name="reportSql" data-bind="value: currentSql" />
                        <input type="hidden" id="connectKey" name="connectKey" data-bind="value: currentConnectKey" />
                        <input type="hidden" id="reportName" name="reportName" data-bind="value: ReportName" />
                        <button type="submit" class="btn btn-default btn-xs"><span class="fa fa-file-excel-o"></span></button>
                        }
                    </div>
                    <a data-bind="attr: {href: '@Url.Action(" Index","Report")?reportId=' + ReportID()}" class="btn btn-default btn-xs pull-right">
                        <i class="fa fa-pencil-square-o" title="Edit Report"></i>
                    </a>
                </div>
                <div class="panel-body list-overflow-auto">
                    <p data-bind="html: ReportDescription">
                    </p>
                    <div data-bind="with: ReportResult">
                        <div data-bind="template: 'report-template', data: $data"></div>
                    </div>
                </div>
                <div class="panel-footer">
                    <div class="small" data-bind="with: pager">
                        <div class="form-group pull-left total-records">
                            <span data-bind="text: 'Total Records: ' + totalRecords()"></span><br />
                        </div>
                        <div class="form-group pull-right" data-bind="if: pages()>1">
                            <div data-bind="template: 'pager-template', data: $data"></div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /ko -->
</div>
<div class="clearfix"></div>

<div class="modal fade" id="add-dashboard-modal" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content" data-bind="with: dashboard">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"><span></span> a new Data Connection</h4>
            </div>
            <div class="modal-body">
              
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-bind="click: $root.addDashboard">Create</button>
            </div>
        </div>
    </div>
</div>


