@using System.Configuration
@model DotNetDashboardModel
@{
    ViewBag.Title = "Combined";
    Layout = "~/Views/shared/_Layout.Report.cshtml";
}

@section head {
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.min.css" />
    @*<style>
        .grid-stack > .grid-stack-item > .grid-stack-item-content {
            position: relative;
            overflow-x: visible;
            overflow-y: visible;
        }
    </style>*@
}

@section scripts{
    <script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.min.js'></script>
    <script type="text/javascript" src='//cdnjs.cloudflare.com/ajax/libs/gridstack.js/0.4.0/gridstack.jQueryUI.min.js'></script>
    <script type="text/javascript">
    function downloadPdf() {
        $("#downloadPdf").submit();
    }
    function downloadExcel() {
        $("#downloadExcel").submit();
    }

    function downloadXml() {
        $("#downloadXml").submit();
    }

    $(document).ready(function () {
        var reports = [];
        var dashboards = [];

        @foreach (var d in Model.Dashboards)
        {
        @:dashboards.push({ id: @d.Id, name: "@d.Name", description: "@d.Description", selectedReports: "@d.SelectedReports", userId: "@d.UserId", userRoles: "@d.UserRoles", viewOnlyUserId: "@d.ViewOnlyUserId", viewOnlyUserRoles: "@d.ViewOnlyUserRoles"  });
        }

        @foreach (var r in Model.Reports)
        {
        @:reports.push({ reportSql: "@r.ReportSql", reportId: @r.ReportId, reportFilter: htmlDecode('@System.Web.HttpUtility.UrlDecode(r.ReportFilter)'), connectKey: "@r.ConnectKey", x: @r.X, y: @r.Y, width: @r.Width, height: @r.Height });
        }

        ajaxcall({ url: '@Url.Action("GetUsersAndRoles")' }).done(function (data) {
            var vm = new combinedViewModel({
                runReportUrl: "@Url.Action("Report")",
                execReportUrl: "@Url.Action("RunReport")",
                reportWizard: $("#filter-panel"),
                lookupListUrl: "@Url.Action("GetLookupList")",
                apiUrl: "@Url.Action("CallReportApi")",
                runReportApiUrl: "@Url.Action("RunReportApi")",
                reportMode: "execute",
                reports: reports,
                dashboards: dashboards,
                users: data.users,
                userRoles: data.userRoles,
                allowAdmin: data.allowAdminMode,
                dashboardId: @(Request.QueryString["id"] != null ? Request.QueryString["id"] : "0")
            });

            vm.init().done(function () {
                
                ko.applyBindings(vm);

                $(function () {
                    var options = {
                        cellHeight: 80,
                        verticalMargin: 10
                    };
                    $('.grid-stack').gridstack(options);
                    $('.grid-stack').on('change', function (event, items) {
                        _.forEach(items, function (x) {
                            vm.updatePosition(x);
                        });
                    });
                });

                setTimeout(function () {
                    vm.drawChart();
                }, 1000);

                @if (Request.QueryString["add"] == "1")
                {
                    @:vm.newDashboard();
                    @:$('#add-dashboard-modal').modal('show');
                }
                
            });

            $(window).resize(function () {
                vm.drawChart();
            });
        });
    });
    </script>
}

<div class="row">
    <div class="col-6" data-bind="with: currentDashboard">
        <h2 data-bind="text: name ? name : 'Combined Report'"></h2>
        <p data-bind="text: description"></p>
    </div>    
</div>
<div class="clearfix"></div>

<div class="modal modal-fullscreen" id="add-dashboard-modal" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content" data-bind="with: dashboard">
            <div class="modal-header">
                <h4 class="modal-title"><span data-bind="text: Id() ? 'Edit' : 'Add'"></span> Combined Report</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="control-group">
                        <div class="form-group row">
                            <label class="col-md-3 col-sm-3 control-label">Name</label>
                            <div class="col-md-6 col-sm-6">
                                <input class="form-control text-box" style="width: 100%;" data-val="true" data-val-required="Combined Report Name is required." type="text" data-bind="value: Name" placeholder="Combined Report Name, ex Sales Summary, Accounting Summary" id="add-dash-name" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-md-3 col-sm-3 control-label">Description</label>
                            <div class="col-md-6 col-sm-6">
                                <textarea class="form-control text-box" style="width: 100%;" data-bind="value: Description" placeholder="Optional Description for the Combined Report">
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <hr />
                <h5><span class="fa fa-paperclip"></span> Choose Reports for the Combined Report</h5>
                <div data-bind="foreach: $parent.reportsAndFolders" class="card" style="margin-left: 20px;">
                    <div class="card-body">
                        <a class="btn btn-link" role="button" data-toggle="collapse" data-bind="attr: {href: '#folder-' + folderId }">
                            <i class="fa fa-folder"></i>&nbsp;<span data-bind="text: folder"></span>
                        </a>
                        <div class="collapse" data-bind="attr: {id: 'folder-' + folderId }">
                            <ul class="list-group" data-bind="foreach: reports">
                                <li class="list-group-item">
                                    <div class="checkbox">
                                        <label class="list-group-item-heading">
                                            <input type="checkbox" data-bind="checked: selected">
                                            <span class="fa" data-bind="css: {'fa-file': reportType=='List', 'fa-th-list': reportType=='Summary', 'fa-bar-chart': reportType=='Bar', 'fa-pie-chart': reportType=='Pie',  'fa-line-chart': reportType=='Line', 'fa-globe': reportType =='Map'}" style="font-size: 14pt; color: #808080"></span>
                                            <span data-bind="text: reportName"></span>
                                        </label>
                                    </div>
                                    <p class="list-group-item-text small" data-bind="text: reportDescription"></p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- ko if: $parent.adminMode -->
                <hr />
                <div data-bind="template: {name: 'manage-access-template'}"></div>
                <!-- /ko -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bind="click: function() {$root.cancelCombinedReport('@Url.Action("Index","Report")')}">Cancel Combined Report</button>
                <button type="button" class="btn btn-danger" data-bind="click: $root.deleteDashboard, visible: Id">Delete Combined Report</button>
                <button type="button" class="btn btn-primary" data-bind="click: $root.saveDashboard">Save Combined Report</button>
            </div>
        </div>
    </div>
</div>

<div class="clearfix"></div>

<div class="report-view">
    <div data-bind="with: $root">
        @using (Html.BeginForm("DownloadCombinedPdf", "Report", FormMethod.Post, new { id = "downloadPdf" }))
        {
            <input type="hidden" id="id" name="id" data-bind="value: currentDashboard().id" />
            <input type="hidden" id="combinedReportName" name="combinedReportName" data-bind="value: currentDashboard().name ? currentDashboard().name : 'Combined Report'" />
            <input type="hidden" id="printUrl" name="printUrl" value="@Url.Action("CombinedPrint", "Report", null, this.Request.Url.Scheme)" />
            <input type="hidden" id="adminMode" name="adminMode" value="false" />
            <input type="hidden" id="combinedFilters" name="combinedFilters" data-bind="value: stringifyFlyFilters()" />
        }
    </div>

    <div class="pull-right">
        <a href="@Url.Action("Index","Report")" class="btn btn-primary">
            Back to Reports
        </a>

        <button class="btn btn-primary" data-toggle="modal" data-target="#add-dashboard-modal" title="Edit Combined Report Settings" data-bind="click: editDashboard">Edit Report</button>

        <button type="button" class="btn btn-secondary">
            <span class="fa fa-print" aria-hidden="true"></span> Print Report
        </button>

        <div class="btn-group">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="fa fa-download"></span> Export <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li class="dropdown-item">
                    <a href="#" onclick="downloadPdf();">
                        <span class="fa fa-file-pdf-o"></span> Pdf
                    </a>
                </li>
                <li class="dropdown-item">
                    <a href="#">
                        <span class="fa fa-file-excel-o"></span> Excel
                    </a>
                </li>
                <li class="dropdown-item">
                    <a href="#">
                        <span class="fa fa-file-code-o"></span> Xml
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div style="clear: both;"></div>
    <br />

    <div data-bind="template: {name: 'fly-filter-template'}"></div>

    <div class="grid-stack">
        <!-- ko foreach: reports -->
        <div class="grid-stack-item" data-bind="attr: {'data-gs-x': x, 'data-gs-y': y, 'data-gs-width': width, 'data-gs-height': height, 'data-gs-auto-position': true, 'data-gs-id': ReportID}">

            <div class="card" data-bind="attr: {class: 'card ' + panelStyle + ' grid-stack-item-content'}" style="overflow-y: hidden;">
                <div class="card-header">
                    <span data-bind="text: ReportName"></span>

                </div>
                <div class="card-body list-overflow-auto">
                    <p data-bind="html: ReportDescription">
                    </p>
                    <div data-bind="template: {name: 'fly-filter-template'}, visible: showFlyFilters"></div>
                    <div data-bind="with: ReportResult">
                        <div data-bind="template: 'report-template', data: $data"></div>
                    </div>
                </div>
            </div>

        </div>
        <!-- /ko -->
    </div>
</div>

